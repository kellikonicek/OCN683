---
title: "konicek_homework_5"
author: "kelli"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r}
library(tidyverse)
library(here)
library(ggeffects)
library(GGally)
library(effects)
library(ggResidpanel)
library(performance)
library(car)
library(arm)
library(VGAM)
library(MASS)
```

# Upload Data
```{r}
raw_kole <- read_csv(here("week_5", "data","CRCP_Reef_Fish_Surveys_Hawaii_kole.csv"))
```

_We are interested in the habitat characteristics that favor kole. We will focus on the role of different types of benthic substrate, and the most common substrate types in this dataset are turf algae (column ‘ta’), hard coral (column ‘hard_coral’), sand (column ‘sand’), and crustose coralline algae (column ‘cca’)._

Four predictors: ta, hard_coral,sand,cca

# (1) 

_Start by exploring the distributions of the four predictor variables, and how they are correlated with one another. The function ggpairs() in the package GGally is particularly nice for this._
```{r}

substrate <- raw_kole %>% 
  dplyr::select(taxonname,count,ta,hard_coral,sand,cca)%>%
  pivot_longer(cols = ta:cca, #columns you want to pivot
               names_to = "substrates", #names of new columns with all the variables
               values_to = "percent")%>% #name of the new column with all the values
ggplot(aes(percent,log(count), color = substrates)) + geom_point()

ggpairs(raw_kole,columns=c(3,17,20,21,22))
substrate
```
OKAY. It looks like crustose coralline algae and hard coral are positively correlated, which makes sense based on the... 45 seconds... of googling I did about what the heck cca is. It also seems sand is negatively correlated with everything, which makes sense, and turf algae is negatively correlated with the other available predictors as well. 

# (2) 

_For each of the four predictors, make single-predictor models where the response variable is kole counts. Consider which of the predictors could be transformed to reduce skew along the x-axis. For educational purposes, start by using a poisson distribution for the counts._


```{r}

#check for skew
hist(raw_kole$ta)
hist(sqrt(raw_kole$ta))
hist(raw_kole$hard_coral)
hist(sqrt(raw_kole$hard_coral))
hist(raw_kole$sand)
hist(sqrt(raw_kole$sand))
hist(raw_kole$cca)
hist(sqrt(raw_kole$cca))


```
Based on the histograms I made, I think hard coral, sand, and cca could probably be transformed to reduce x-axis skew. Is that bad though to not transform all of them? SAND was the answer. 


```{r}
#try transforming? 
sqrt_kole <- raw_kole %>%
  mutate(count=count,
    ta=sqrt(ta),
         hard_coral=sqrt(hard_coral),
         sand=sqrt(sand),
         cca=sqrt(cca))
```

```{r}
# Single predictor poisson 
pois_ta <- glm(count ~ ta, data = sqrt_kole, family = poisson)
pois_hard_coral <- glm(count ~ hard_coral, data = sqrt_kole, family = poisson)
pois_sand <- glm(count ~ sand, data = sqrt_kole, family = poisson)
pois_cca <- glm(count ~ cca, data = sqrt_kole, family = poisson)

# Summaries of each model
summary(pois_ta)

summary(pois_hard_coral)

summary(pois_sand)

summary(pois_cca)

```


_Quantify the degree of overdispersion in these models, and describe what it means._
```{r}
dispersion = function(model) {
sum(residuals(model, type = "pearson")^2)/(length(model$y) -
length(model$coefficients))
}

dispersion(pois_ta)
dispersion(pois_hard_coral)
dispersion(pois_sand)
dispersion(pois_cca)
```
Well, if there's no overdisperson the parameter should be around 1... 30 is... well, that's more. A lot more. This essentially means that the mean is NOT equal to the distribution of the variance like it is supposed to be with poisson, so we are violating the assumption that lambda equals the variance and the mean. 



_Based on likelihood ratio tests and effects plots, what are the relationships between kole and the four substrate types?_
```{r}
#LRT:
Anova(pois_ta)
Anova(pois_hard_coral)
Anova(pois_sand)
Anova(pois_cca)

#look at residuals too why not 
resid_panel(pois_ta, type = "pearson")
resid_panel(pois_hard_coral, type = "pearson")
resid_panel(pois_sand, type = "pearson")
resid_panel(pois_cca, type = "pearson")

# Plot the effects
plot(ggeffect(pois_ta))
plot(ggeffect(pois_hard_coral))
plot(ggeffect(pois_sand))
plot(ggeffect(pois_cca))

```

Oof. Well, it looks like counts go up with percent cover of hard coral and cca, and go down with turf algae and sand. All of the liklihood tests are very significant, but the residual plots and the Q-Q plots look skewed.



# (3) 

_Now make new single-predictor models that account for overdispersion (we
discussed two different ways to do this in lecture, you can do one or both)._

The two we've talked about are quasi-poisson and negative binomial. I will pick negative binomial so I can have a liklihood. 

```{r}
#models
nbta <- glm.nb(count ~ ta, data = sqrt_kole)
nbhc <- glm.nb(count ~ hard_coral, data = sqrt_kole)
nbsa <-glm.nb(count ~ sand, data = sqrt_kole)
nbcca <- glm.nb(count ~ cca, data = sqrt_kole)

summary(nbta)
summary(nbhc)
summary(nbsa)
summary(nbcca)

#liklihood
Anova(nbta)
Anova(nbhc)
Anova(nbsa)
Anova(nbcca)

#new overdispersion
dispersion(nbta)
dispersion(nbhc)
dispersion(nbsa)
dispersion(nbcca)

#new effects plots
# Plot the effects
plot(ggeffect(nbta))
plot(ggeffect(nbhc))
plot(ggeffect(nbsa))
plot(ggeffect(nbcca))
```


_How have the results changed compared to #2, and why?_

The LR Chisq values are lower, the null/residual deviance is lower, and the liklihood p value is higher, but all still show they are significantly influence the count. The effects plots are also taking the variation more into account than the poisson was. The overdispersion parameters are also WAY lower, to what is probably appropriate for these data. 

# (4) 

_Although the single-predictor models are useful, we may get a more accurate
picture of the role of each substrate type if we include all the substrate types in one model. Create such a model._

shoudl actually do ~sand.sqrt+ccasqrt+hard_coral.sqrt+ta-- what's the relationship with sand when you control for all the other types? 


```{r}

nball <- glm.nb(count ~ ta*hard_coral*sand*cca, data = sqrt_kole)
summary(nball)
```



_Based on likelihood ratio tests and effects plots, how do the results change when all predictors are included simultaneously? Why do you think the results have changed? Don’t forget to make some residual diagnostic plots as well._

```{r}
#LRT
Anova(nball)

#effects
plot(ggeffect(nball))


#residual diagnostics
#extract
d_residuals <- residuals(nball, type = "deviance")
#plot
ggplot(data = data.frame(fitted = fitted(nball), d_residuals), aes(x = fitted, y = d_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Deviance Residuals")

```


_Finally, what are your overall conclusions about the substrate associations of kole,from this look at the data? Are there any additional analyses you would want to do that we have not done in this assignment?_

Based on the LRT, it looks like hard coral and cca impact kole counts.There also might be an interaction between turf algae, hard coral, and sand that impacts counts as well. Maybe if a chunk of hard coral is present near sand or turf algae, that partial amount can still impact kole counts? 


I am not sure if I decided correctly to add interactions between the substrates (I did because I am assuming they, like turf algae, might be percent cover-- it also looks like the substrates themselves might be positively-negatively correlated to each other from the first question, which I think means they would not be purely additive? I could be wrong, I am still struggling understanding this in different situations). 

It also looks like the slopes changed a bit for everyone, particularly for sand and ta. Maybe this is because overdispersion was causing some outliers to have more influence than they should have. 


I think adding in depth might be an important thing to add into the model if we were analyzing this more, just since the range is from from 1 to 30 and I don't know if that's a big difference for this fish. I also think doing habitat type might help answer whether or not my substrate interaction question has any relevance-- if there are habitat types that combine substrates that have a significant effect on counts, maybe. 




________ DHARMa-- nonparametric dispersion test via sd of residuals fitted vs. simiulated-- can make new corrected QQ plots, calculate dispersion for Glms 
